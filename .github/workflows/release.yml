name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build from"
        required: true
        default: main

env:
  GO_VERSION: "1.21"
  NODE_VERSION: "18"
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  build:
    name: Build ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          # Windows builds
          - name: Windows amd64
            os: windows-latest
            platform: windows/amd64
            output: vsynx-manager-windows-amd64
            ext: .exe
            # Windows arm64 and 386 NSIS support might be tricky with standard Wails without config
            # defaulting to standard build for simplicity on secondary archs or enabling if possible
            # validating mainly amd64 installer for now as standard
            installer: true
          - name: Windows arm64
            os: windows-latest
            platform: windows/arm64
            output: vsynx-manager-windows-arm64
            ext: .exe
          - name: Windows 386
            os: windows-latest
            platform: windows/386
            output: vsynx-manager-windows-386
            ext: .exe

          # macOS builds
          - name: macOS amd64
            os: macos-latest
            platform: darwin/amd64
            output: vsynx-manager-macos-amd64
            ext: ""
          - name: macOS arm64
            os: macos-latest
            platform: darwin/arm64
            output: vsynx-manager-macos-arm64
            ext: ""

          # Linux builds
          - name: Linux amd64
            os: ubuntu-22.04
            platform: linux/amd64
            output: vsynx-manager-linux-amd64
            ext: ""

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref }}

      - name: Make release scripts executable
        run: chmod +x scripts/release/*.sh
        shell: bash

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Linux dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      # Windows dependencies (NSIS)
      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        run: choco install nsis -y

      # macOS dependencies (create-dmg)
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: brew install create-dmg

      # Install Wails
      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      # Install frontend dependencies
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      # Build application
      - name: Build Wails app
        run: |
          bash scripts/release/build_wails.sh \
            "${{ matrix.config.platform }}" \
            "${{ matrix.config.output }}" \
            "${{ matrix.config.ext }}" \
            "${{ matrix.config.installer }}"
        shell: bash

      # Build CLI binary separately
      - name: Build CLI binary
        run: |
          bash scripts/release/build_cli.sh \
            "${{ matrix.config.platform }}" \
            "${{ matrix.config.ext }}"
        shell: bash

      # Package macOS DMG
      - name: Create DMG (macOS)
        if: runner.os == 'macOS'
        run: |
          bash scripts/release/create_dmg_macos.sh "${{ matrix.config.output }}"
        shell: bash

      # Prepare Windows Installer for Upload
      - name: Prepare Windows Installer
        if: runner.os == 'Windows' && matrix.config.installer == 'true'
        run: |
          cd build/bin
          # Find the installer executable (Wails names it project-version-arch-installer.exe)
          Get-ChildItem -Filter "*-installer.exe" | ForEach-Object {
            Move-Item $_.FullName "${{ matrix.config.output }}-setup.exe" -Force
            echo "Renamed installer: $($_.Name) to ${{ matrix.config.output }}-setup.exe"
          }
        shell: pwsh

      # Create Archives (fallback for all platforms)
      - name: Create archive (Linux)
        if: runner.os == 'Linux'
        run: |
          cd build/bin
          tar -czvf ../../${{ matrix.config.output }}.tar.gz *

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        run: |
          cd build/bin
          7z a -tzip ../../${{ matrix.config.output }}.zip *
        shell: cmd

      # Upload artifacts
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.config.output }}
          path: |
            ${{ matrix.config.output }}.tar.gz
            ${{ matrix.config.output }}.zip
            build/bin/${{ matrix.config.output }}.dmg
            build/bin/${{ matrix.config.output }}-setup.exe
          if-no-files-found: ignore

  # Create GitHub Release
  release:
    if: startsWith(github.ref, 'refs/tags/')
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          # Find and copy all assets, flattened
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.dmg" -o -name "*.exe" \) -exec cp {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Vsynx Manager ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
